<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Building Demolition Analysis</title>
    <meta name="description" content="Interactive dashboard analyzing Boston building demolitions with plasma color scheme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .methodology {
            background: #f8f9fa;
            padding: 20px;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }

        .methodology h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .methodology p {
            color: #555;
            line-height: 1.8;
        }

        .methodology .stats {
            margin-top: 10px;
            font-weight: 500;
            color: #3498db;
        }

        .controls {
            background: white;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-group {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 10px;
        }

        .control-group label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        select, button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, button:hover {
            border-color: #3498db;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            font-weight: 500;
        }

        button:hover {
            background: #2980b9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-unit {
            font-size: 0.5em;
            color: #666;
            font-weight: normal;
        }

        .chart-container {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        canvas {
            max-height: 400px;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 4px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            margin-top: 40px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .control-group {
                display: block;
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            select, button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Boston Building Demolition Analysis</h1>
            <p class="subtitle" id="subtitle">Building Lifecycle and Demolition Patterns</p>
            
            <div class="methodology">
                <h3>Data Source & Methodology</h3>
                <p>
                    This analysis combines data from the <strong>Boston Property Assessment Dataset</strong> (a snapshot of currently existing buildings) and the <strong>Boston Approved Building Permits</strong> (a historical record of work from 2009-2025). The methodology is designed to accurately link historical demolitions to the correct building records and interpret the results.
                </p>
                <ol style="margin-left: 20px; padding-left: 10px; line-height: 1.8;">
                    <li style="margin-bottom: 10px;">
                        <strong>Building-Centric Matching:</strong> To analyze entire buildings, not just individual condo units, a unified <strong>'Building ID'</strong> is created. For condominiums, this ID is based on the shared <code>CM_ID</code>; for other properties, the <code>PID</code> is used. This ensures demolition permits for apartment buildings are correctly matched to the entire structure.
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>Identifying a Single Demolition Event:</strong> A key challenge is that one building may have multiple <code>RAZE</code> (full demolition) permits in the dataset due to administrative updates or redevelopment cycles. The logic enforces a <strong>"one building, one final demolition"</strong> rule by:
                        <ul style="margin-top: 5px; margin-left: 20px;">
                            <li>Prioritizing permits that result in a positive lifespan (demolition year > build year).</li>
                            <li>Then, selecting only the most recent permit for that building.</li>
                            <li>Additionally, identical permits (same parcel and type) issued within a <strong>24-hour window</strong> are consolidated to remove data entry noise.</li>
                        </ul>
                    </li>
                    <li style="margin-bottom: 10px;">
                        <strong>Interpreting Lifespan:</strong> Building lifespan is calculated by subtracting the construction year from the demolition year. The results are interpreted in two distinct ways:
                        <ul style="margin-top: 5px; margin-left: 20px;">
                            <li>A <strong>positive lifespan</strong> represents an observable, complete life cycle of a demolished building. These records are used to calculate statistics like average lifespan.</li>
                            <li>A <strong>non-positive lifespan (≤ 0)</strong> is not an error. It's a powerful signal of urban renewal, indicating that a historic demolition occurred on a parcel that has since been redeveloped with a newer building. These are categorized as <strong>"Demolished and Replaced"</strong> events.</li>
                        </ul>
                    </li>
                </ol>
                <p style="margin-top: 15px;">
                    <strong>Demolition Permit Types:</strong><br>
                    <strong>RAZE:</strong> Building Demolition(Instead of the 'demolished and replaced' part in Demolitions by Year plot, every plot's RAZE ONLY reflect positive life-span).<br>
                    <strong>EXTDEM:</strong> Exterior Demolition (without razing the structure).<br>
                    <strong>INTDEM:</strong> Interior Demolition (without razing the structure).
                <br><br>
                <em>(Please note: As official definitions for these permit codes are unavailable, the explanations provided are based on standard industry terminology.)</em>
                </p>
            </div>
        </div>



        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Raze(Positive-lifespan)</div>
                <div class="stat-value" id="totalDemo">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Lifespan <span class="stat-unit">(RAZE)</span></div>
                <div class="stat-value" id="avgLifespan">0 <span class="stat-unit">years</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Exterior Demolitions</div>
                <div class="stat-value" id="extdemCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Interior Demolitions</div>
                <div class="stat-value" id="intdemCount">0</div>
            </div>
        </div>
        

        <!-- RAZE Lifespan Summary (placed ABOVE the Demolition Locations Map container) -->
        <div class="chart-container" id="raze-lifespan-summary-container">
        <h2 class="chart-title">RAZE Lifespan Summary</h2>

        <!-- compact 4-up stat row -->
        <div id="razeLifespanSummary" style="display:flex; gap:16px; flex-wrap:wrap;">
            <div class="mini-stat" style="padding:8px 10px; border:1px solid #eee; border-radius:8px; min-width:150px;">
            <div style="font-size:12px; opacity:.75;">RAZE lifespan &gt; 0</div>
            <div id="razePosCount" style="font-weight:600; font-size:16px;">—</div>
            </div>
            <div class="mini-stat" style="padding:8px 10px; border:1px solid #eee; border-radius:8px; min-width:150px;">
            <div style="font-size:12px; opacity:.75;">RAZE lifespan = 0</div>
            <div id="razeZeroCount" style="font-weight:600; font-size:16px;">—</div>
            </div>
            <div class="mini-stat" style="padding:8px 10px; border:1px solid #eee; border-radius:8px; min-width:150px;">
            <div style="font-size:12px; opacity:.75;">RAZE lifespan &lt; 0</div>
            <div id="razeNegCount" style="font-weight:600; font-size:16px;">—</div>
            </div>
            <div class="mini-stat" style="padding:8px 10px; border:1px solid #eee; border-radius:8px; min-width:150px;">
            <div style="font-size:12px; opacity:.75;">RAZE total (by lifespan)</div>
            <div id="razeTotalCount" style="font-weight:700; font-size:16px;">—</div>
            </div>
        </div>
        </div>


        <div class="chart-container">
            <h2 class="chart-title">Demolition Locations Map</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Each point represents a demolished building. Color indicates demolition type. Hover over a point to see its lifespan.
            </p>

            <div class="control-group" style="margin-bottom: 10px;">
            <label>Demolition Type</label>
            <select id="demolitionFilter" onchange="updateCharts()">
                <option value="all">All Types (Stacked)</option>
                <option value="EXTDEM">Exterior Demolition Only</option>
                <option value="INTDEM">Interior Demolition Only</option>
                <option value="RAZE" selected>Raze Only</option>
            </select>
            </div>

            <div id="map"></div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Demolitions by Year</h2>

            <div style="display:flex; gap:24px; flex-wrap:wrap; margin-bottom:10px;">
            <div class="control-group">
                <label>Chart Type</label>
                <select id="chartType" onchange="updateCharts()">
                <option value="bar">Bar Chart</option>
                <option value="area">Area Chart</option>
                <option value="line">Line Chart</option>
                </select>
            </div>

            <div class="control-group">
                <label>View Mode</label>
                <select id="viewMode" onchange="updateCharts()">
                <option value="absolute">Absolute Numbers</option>
                <option value="percentage">Percentage</option>
                </select>
            </div>

            <div class="control-group">
                <label>Lifespan Bin Size</label>
                <select id="binSize" onchange="updateCharts()">
                <option value="5">5 Years</option>
                <option value="10" selected>10 Years</option>
                <option value="20">20 Years</option>
                </select>
            </div>
            </div>

            <canvas id="yearlyChart"></canvas>
        </div>

        <!-- MODIFIED: Changed title and will update y-axis label -->
        <div class="chart-container">
            <h2 class="chart-title">Age Distribution of Demolished Buildings in Boston</h2>
            <canvas id="lifespanChart"></canvas>
        </div>

        <!-- NEW: Current building age distribution chart -->
        <div class="chart-container">
            <h2 class="chart-title">Age Distribution of Current Buildings in Boston</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Shows the age distribution of all existing buildings in the Boston property assessment database
            </p>
            <canvas id="currentAgeChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Demolition Type Breakdown</h2>
            <canvas id="typeChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Age Distribution of Demolished Buildings by Year (Click Legend to Interact)</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Shows the relative ages of buildings demolished each year, based on their lifespan at demolition
            </p>
            <canvas id="ageDistributionChart"></canvas>
        </div>

        <!-- NEW: Construction era chart -->
        <div class="chart-container">
            <h2 class="chart-title">Construction Era of Demolished Buildings by Year (Click Legend to Interact)</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Shows when demolished buildings were originally constructed, grouped by historical eras
            </p>
            <canvas id="constructionEraChart"></canvas>
        </div>

        <!-- MODIFIED: Updated title and description -->
        <div class="chart-container">
            <h2 class="chart-title">Building Lifespan Distribution by Demolition Year (Strip Plot)</h2>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                Each point represents a building's age at demolition. Points are jittered horizontally to show density.
            </p>
            <canvas id="lifespanStripPlot"></canvas>
        </div>
    </div>

    <div class="footer">
        Data Source: City of Boston Open Data | Analysis Date: 2025
    </div>

    <script>
        let currentData = null;
        let charts = {};
        let map = null;
        let pointLayer = null;

        const colors = {
            RAZE: 'rgba(13, 8, 135, 0.8)',
            EXTDEM: 'rgba(204, 71, 120, 0.8)',
            INTDEM: 'rgba(254, 206, 50, 0.8)',
            single: 'rgba(126, 3, 168, 0.8)',
            demolished_and_replaced: 'rgba(0, 0, 0, 0.75)'
        };

        const borderColors = {
            RAZE: 'rgba(13, 8, 135, 1)',
            EXTDEM: 'rgba(204, 71, 120, 1)',
            INTDEM: 'rgba(254, 206, 50, 0.8)',
            single: 'rgba(126, 3, 168, 1)',
            demolished_and_replaced: 'rgba(0, 0, 0, 0.75)'

        };


        // Update the RAZE lifespan summary (the container ABOVE the map).
        // Numbers are city-wide (not affected by the map dropdown).
        function updateRazeLifespanSummary(currentData) {
        if (!currentData || !currentData.summary_stats) return;

        const s = currentData.summary_stats;

        // Positive-lifespan RAZE: prefer city-wide count before geo; fall back to geo-filtered.
        const pos  = (typeof s.raze_count_before_geo === 'number') ? s.raze_count_before_geo : (s.raze_count || 0);
        const zero = s.zero_raze_count || 0;
        const neg  = s.negative_raze_count || 0;
        const total = pos + zero + neg;

        const elPos   = document.getElementById('razePosCount');
        const elZero  = document.getElementById('razeZeroCount');
        const elNeg   = document.getElementById('razeNegCount');
        const elTotal = document.getElementById('razeTotalCount');

        if (elPos)   elPos.textContent   = pos.toLocaleString();
        if (elZero)  elZero.textContent  = zero.toLocaleString();
        if (elNeg)   elNeg.textContent   = neg.toLocaleString();
        if (elTotal) elTotal.textContent = total.toLocaleString();
        }


        // Parse a "start-end" label (e.g., "320-330") into numeric [start, end]
        function parseRange(str) {
        const m = String(str).match(/(\d+)\s*-\s*(\d+)/);
        return m ? [parseInt(m[1]), parseInt(m[2])] : [0, 0];
        }

        // Get the maximum right edge from a series of { range: "a-b", ... }
        function getUpperFromSeries(series = []) {
        let max = 0;
        series.forEach(d => {
            const [, end] = parseRange(d.range);
            if (end > max) max = end;
        });
        return max;
        }

        // Compute a global max age upper bound across current-building and demolition series
        function computeGlobalMaxAge(data) {
        const maxCurrent = getUpperFromSeries(data.current_building_age_distribution || []);
        const maxDem10   = getUpperFromSeries(data.lifespan_distribution || []);
        const maxDem5    = getUpperFromSeries(data.lifespan_distribution_5yr || []);
        return Math.max(maxCurrent, maxDem10, maxDem5);
        }


        async function loadDataFromJSON() {
            try {
                const response = await fetch('boston_demolition_data.json');
                if (!response.ok) {
                    showError();
                    return;
                }
                const data = await response.json();
                currentData = data;
                
                if (!data.lifespan_distribution_5yr && data.lifespan_distribution) {
                    data.lifespan_distribution_5yr = data.lifespan_distribution;
                }
                
                updateDashboard(data);
                console.log('Successfully loaded Boston demolition data from JSON');
                
            } catch (error) {
                console.error('Error loading JSON:', error);
                showError();
            }
        }
        
        function showError() {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <strong>Error:</strong> Unable to load boston_demolition_data.json. 
                <br>Please ensure the JSON file is in the same directory as this HTML file.
            `;
            
            const header = document.querySelector('.header');
            if (header && header.parentNode) {
                header.parentNode.insertBefore(errorDiv, header.nextSibling);
            }
            
            document.getElementById('totalDemo').textContent = 'N/A';
            document.getElementById('avgLifespan').innerHTML = 'N/A';
            document.getElementById('extdemCount').textContent = 'N/A';
            document.getElementById('intdemCount').textContent = 'N/A';
        }

        function updateDashboard(data) {
            const stats = data.summary_stats;
            // Show RAZE-only count in the top KPI
            document.getElementById('totalDemo').textContent = stats.raze_count.toLocaleString();
            document.getElementById('extdemCount').textContent = stats.extdem_count.toLocaleString();
            document.getElementById('intdemCount').textContent = stats.intdem_count.toLocaleString();
            
            if (data.metadata && data.metadata.year_range) {
                document.getElementById('subtitle').textContent = 
                    `Building Lifecycle and Demolition Patterns (${data.metadata.year_range})`;
            }

            initMap();
            updateCharts();
        }

        function updateAverageLifespan(filter, data) {
            let lifespan = 0;
            const lifespanElement = document.getElementById('avgLifespan');

            if (filter === 'all') {
                lifespan = data.summary_stats.average_lifespan;
            } else {
                const typeData = data.lifespan_by_type.find(d => d.type === filter);
                if (typeData && typeData.average) {
                    lifespan = typeData.average;
                } else {
                    lifespan = 0; 
                }
            }

            if (lifespan > 0) {
                 lifespanElement.innerHTML = lifespan.toFixed(1) + ' <span class="stat-unit">years</span>';
            } else {
                 lifespanElement.innerHTML = 'N/A';
            }
        }

        function updateCharts() {
            if (!currentData) return;

            const chartType = document.getElementById('chartType').value;
            const selectedForMap = document.getElementById('demolitionFilter').value;
            const chartTypeFilter = 'RAZE'; // lock all non-map visuals to RAZE
            const viewMode = document.getElementById('viewMode').value;
            const binSize = parseInt(document.getElementById('binSize').value);
            const globalMaxAge = computeGlobalMaxAge(currentData);

            updateAverageLifespan('RAZE', currentData);


            createMapPlot(currentData, selectedForMap);  
            createYearlyChart(currentData.yearly_stacked, chartType, chartTypeFilter, viewMode);
            createLifespanChart(currentData.lifespan_distribution, chartType, chartTypeFilter, viewMode, binSize, globalMaxAge);
            createCurrentAgeChart(currentData.current_building_age_distribution, binSize);
            createTypeChart(currentData.demolition_types, chartTypeFilter);
            createAgeDistributionChart(currentData, chartTypeFilter);
            createConstructionEraChart(currentData, chartTypeFilter);
            createLifespanStripPlot(currentData, chartTypeFilter);
            updateRazeLifespanSummary(currentData);
        }
        
        function initMap() {
            if (!map) {
                map = L.map('map').setView([42.3601, -71.0589], 12);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }

        function createMapPlot(data, filter) {
            if (!map) return;

            if (pointLayer) {
                map.removeLayer(pointLayer);
            }

            if (!data.map_points) {
                console.error("Map data ('map_points') is missing from the JSON file.");
                return;
            }
            
            let points_to_plot = data.map_points;

            if (filter !== 'all') {
                points_to_plot = data.map_points.filter(p => p.type === filter);
            }
            
            const markers = [];
            points_to_plot.forEach(point => {
                if (point.lat && point.lng) {
                    const markerColor = colors[point.type] || colors.single;
                    
                    const circleMarker = L.circleMarker([point.lat, point.lng], {
                        radius: 4,      
                        fillColor: markerColor, 
                        color: borderColors[point.type] || borderColors.single,
                        weight: 1,       
                        opacity: 0.6,   
                        fillOpacity: 1 
                    });

                    circleMarker.bindTooltip(`
                        <strong>Type:</strong> ${point.type}<br>
                        <strong>Lifespan:</strong> ${point.lifespan} years
                    `);
                    markers.push(circleMarker);
                }
            });

            pointLayer = L.layerGroup(markers);
            pointLayer.addTo(map);
        }

        function createYearlyChart(yearlyData, chartType, filter, viewMode) {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            
            if (charts.yearly) charts.yearly.destroy();
            
            const years = yearlyData.map(d => d.year);
            let datasets = [];

            if (filter === 'all') {
                ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
                    let data = yearlyData.map(d => d[type] || 0);
                    
                    if (viewMode === 'percentage') {
                        data = yearlyData.map(d => {
                            const total = (d.EXTDEM || 0) + (d.INTDEM || 0) + (d.RAZE || 0);
                            return total > 0 ? ((d[type] || 0) / total) * 100 : 0;
                        });
                    }
                    
                    datasets.push({
                        label: type,
                        data: data,
                        backgroundColor: colors[type],
                        borderColor: borderColors[type],
                        borderWidth: chartType === 'line' ? 2 : 1,
                        fill: chartType === 'area' ? 'stack' : false,
                        tension: 0.1
                    });
                });
            } else if (filter === 'RAZE') {
            // Split RAZE into two stacked series:
            //  - RAZE: positive-age RAZE counts
            //  - demolished and replaced: negative-age RAZE counts
            let razePos = yearlyData.map(d => d['RAZE'] || 0);
            let razeNeg = yearlyData.map(d => d['demolished_and_replaced'] || 0);

            if (viewMode === 'percentage') {
                // use (RAZE + demolished_and_replaced) as the per-year total
                const totals = yearlyData.map(d => (d['RAZE'] || 0) + (d['demolished_and_replaced'] || 0));
                razePos = razePos.map((v, i) => totals[i] ? (v / totals[i]) * 100 : 0);
                razeNeg = razeNeg.map((v, i) => totals[i] ? (v / totals[i]) * 100 : 0);
            }

            datasets.push({
                label: 'RAZE',
                data: razePos,
                backgroundColor: colors['RAZE'],
                borderColor: borderColors['RAZE'],
                borderWidth: chartType === 'line' ? 2 : 1,
                fill: chartType === 'area',
                tension: 0.1
            });

            datasets.push({
                label: 'demolished and replaced (life-span <= 0)',
                data: razeNeg,
                backgroundColor: colors['demolished_and_replaced'],
                borderColor: borderColors['demolished_and_replaced'],
                borderWidth: chartType === 'line' ? 2 : 1,
                fill: chartType === 'area',
                tension: 0.1
            });

            } else {
            // Non-RAZE single-series fallback (kept for completeness)
            let data = yearlyData.map(d => d[filter] || 0);
            datasets.push({
                label: filter,
                data: data,
                backgroundColor: colors[filter],
                borderColor: borderColors[filter],
                borderWidth: chartType === 'line' ? 2 : 1,
                fill: chartType === 'area',
                tension: 0.1
            });
            }


            const chartConfig = {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: (filter === 'all' || filter === 'RAZE') && chartType !== 'line',
                            grid: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    const year = years[index];
                                    const yearRange = years[years.length - 1] - years[0];
                                    
                                    if (yearRange <= 20) {
                                        return year;
                                    } else if (yearRange <= 30) {
                                        return year % 2 === 0 ? year : '';
                                    } else if (yearRange <= 50) {
                                        return year % 5 === 0 ? year : '';
                                    } else {
                                        return year % 10 === 0 ? year : '';
                                    }
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            },
                            title: { display: true, text: 'Demolition Year' }
                        },
                        y: {
                            stacked: (filter === 'all' || filter === 'RAZE') && chartType !== 'line',
                            grid: { borderDash: [2, 2] },
                            title: {
                                display: true,
                                text: viewMode === 'percentage' ? 'Percentage (%)' : 'Number of Demolitions'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: (filter === 'all' || filter === 'RAZE') },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            };

            charts.yearly = new Chart(ctx, chartConfig);
        }

        function createLifespanChart(lifespanData, chartType, filter, viewMode, binSize, globalMaxAge) {
        const ctx = document.getElementById('lifespanChart').getContext('2d');
        if (charts.lifespan) charts.lifespan.destroy();

        // Pick a source series that always exists.
        // If we need 5-year bins → prefer 5yr series; otherwise prefer 10yr series.
        // When the preferred one is missing, gracefully fall back to the other,
        // and we will aggregate by summing base bins fully inside each target bin.
        const series5  = Array.isArray(currentData.lifespan_distribution_5yr)
        ? currentData.lifespan_distribution_5yr : [];
        const series10 = Array.isArray(currentData.lifespan_distribution)
        ? currentData.lifespan_distribution : [];

        let baseSeries;
        if (binSize === 5) {
        baseSeries = series5.length ? series5 : series10;
        } else {
        // 10-year or 20-year views prefer 10yr source; else fall back to 5yr.
        baseSeries = series10.length ? series10 : series5;
        }

        // Sum base bins that are fully inside the target [s, e) range.
        // Works for both 5→10/20 聚合和 10→20 聚合。
        function sumCountsInRange(series, s, e) {
        const acc = { EXTDEM: 0, INTDEM: 0, RAZE: 0 };
        series.forEach(d => {
            const [a, b] = parseRange(d.range);
            if (a >= s && b <= e) {
            acc.EXTDEM += d.EXTDEM || 0;
            acc.INTDEM += d.INTDEM || 0;
            acc.RAZE   += d.RAZE   || 0;
            }
        });
        return acc;
        }

        // Build target labels with the chosen bin size, up to the global max age.
        const labels = [];
        for (let start = 0; start < globalMaxAge; start += binSize) {
        labels.push(`${start}-${start + binSize}`);
        }

        // Aggregate counts into the target bins.
        const finalData = labels.map(lbl => {
        const [s, e] = parseRange(lbl);
        const counts = sumCountsInRange(baseSeries, s, e);
        return { range: lbl, ...counts };
        });



        let datasets = [];
        if (filter === 'all') {
            ['RAZE', 'EXTDEM', 'INTDEM'].forEach(type => {
            let dataArr = finalData.map(d => d[type] || 0);
            if (viewMode === 'percentage') {
                dataArr = finalData.map(d => {
                const total = (d.EXTDEM || 0) + (d.INTDEM || 0) + (d.RAZE || 0);
                return total > 0 ? ((d[type] || 0) / total) * 100 : 0;
                });
            }
            datasets.push({
                label: type,
                data: dataArr,
                backgroundColor: colors[type],
                borderColor: borderColors[type],
                borderWidth: chartType === 'line' ? 2 : 1,
                fill: chartType === 'area' ? 'stack' : false,
                tension: 0.1
            });
            });
        } else {
            let dataArr = finalData.map(d => d[filter] || 0);
            datasets.push({
            label: filter,
            data: dataArr,
            backgroundColor: colors[filter],
            borderColor: borderColors[filter],
            borderWidth: chartType === 'line' ? 2 : 1,
            fill: chartType === 'area',
            tension: 0.1
            });
        }

        const chartConfig = {
            type: chartType === 'area' ? 'line' : chartType,
            data: { labels, datasets },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                stacked: filter === 'all' && chartType !== 'line',
                grid: { display: false },
                title: { display: true, text: 'Lifespan (Years)' },
                ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: false,
                    callback: function(_, index) {
                    if (binSize === 5 && labels.length > 20) {
                        return index % 2 === 0 ? labels[index] : '';
                    }
                    return labels[index];
                    }
                }
                },
                y: {
                stacked: filter === 'all' && chartType !== 'line',
                grid: { borderDash: [2, 2] },
                title: {
                    display: true,
                    text: viewMode === 'percentage' ? 'Percentage (%)' : 'Number of Buildings Demolished'
                },
                beginAtZero: true
                }
            },
            plugins: {
                legend: { display: filter === 'all' },
                tooltip: { mode: 'index', intersect: false }
            }
            }
        };

        charts.lifespan = new Chart(ctx, chartConfig);
        }


        // NEW: Function to create current building age chart
        // Replaces the original function. Now supports 5/10/20-year bins via the binSize argument.
        function createCurrentAgeChart(ageData10yr, binSize) {
        const ctx = document.getElementById('currentAgeChart').getContext('2d');

        if (charts.currentAge) charts.currentAge.destroy();
        if (!ageData10yr) {
            console.warn('No current building age data available');
            return;
        }

        // Local helper to parse a "start-end" string label (e.g., "120-130") into [start, end]
        function parseRangeLocal(str) {
            const m = String(str).match(/(\d+)\s*-\s*(\d+)/);
            return m ? [parseInt(m[1]), parseInt(m[2])] : [0, 0];
        }

        // Select base series: 10-year is provided as function input; 5-year (if present) is read from JSON.
        const base10 = Array.isArray(ageData10yr) ? ageData10yr : [];
        const base5  = (currentData && Array.isArray(currentData.current_building_age_distribution_5yr))
            ? currentData.current_building_age_distribution_5yr
            : [];

        let seriesToPlot = [];

        if (binSize === 5 && base5.length) {
            // Use the 5-year distribution directly (highest fidelity).
            seriesToPlot = base5;
        } else if (binSize === 10) {
            // Use the 10-year distribution as-is (backward compatible).
            seriesToPlot = base10;
        } else {
            // 20-year bins: aggregate from the 10-year distribution (or 5-year if 10-year is missing).
            const src = base10.length ? base10 : base5;
            // Compute the maximum right edge to know how far to bin.
            let maxEnd = 0;
            src.forEach(d => {
            const [, e] = parseRangeLocal(d.range);
            if (e > maxEnd) maxEnd = e;
            });
            const aggregated = [];
            for (let start = 0; start < maxEnd; start += 20) {
            let count = 0;
            src.forEach(d => {
                const [a, b] = parseRangeLocal(d.range);
                // Only count base bins fully inside the 20-year target bin
                if (a >= start && b <= start + 20) count += d.count || 0;
            });
            if (count > 0) aggregated.push({ range: `${start}-${start + 20}`, count });
            }
            seriesToPlot = aggregated;
        }

        // Trim trailing empty bins to keep the right edge clean
        let lastMeaningfulIndex = -1;
        for (let i = seriesToPlot.length - 1; i >= 0; i--) {
            if ((seriesToPlot[i].count || 0) > 0) { lastMeaningfulIndex = i; break; }
        }
        const trimmedData = lastMeaningfulIndex >= 0 ? seriesToPlot.slice(0, lastMeaningfulIndex + 1) : seriesToPlot;

        const labels = trimmedData.map(d => d.range);
        const data   = trimmedData.map(d => d.count);

        const chartConfig = {
            type: 'bar',
            data: {
            labels,
            datasets: [{
                label: 'Current Buildings',
                data,
                backgroundColor: 'rgba(52, 152, 219, 0.8)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1,
                minBarLength: 2
            }]
            },
            options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: {
                grid: { display: false },
                // Unify x-axis annotation with the top chart
                title: { display: true, text: 'Building Age (Years)' },
                ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: false,
                    // Thin out labels only when we are in dense 5-year mode
                    callback: function(value, index) {
                    if (binSize === 5 && labels.length > 20) {
                        return index % 2 === 0 ? labels[index] : '';
                    }
                    return labels[index];
                    }
                }
                },
                y: {
                grid: { borderDash: [2, 2] },
                title: { display: true, text: 'Number of Current Buildings' },
                beginAtZero: true
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                callbacks: {
                    label: function(context) {
                    const value = context.parsed.y;
                    return ` ${value.toLocaleString()}`;
                    }
                }
                }
            }
            }
        };

        charts.currentAge = new Chart(ctx, chartConfig);
        }


        function createTypeChart(typesData, filter) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            if (charts.type) charts.type.destroy();
            
            let filteredData = filter === 'all' 
                ? typesData 
                : typesData.filter(d => d.type === filter);

            const data = {
                labels: filteredData.map(d => d.type),
                datasets: [{
                    data: filteredData.map(d => d.count),
                    backgroundColor: filteredData.map(d => colors[d.type]),
                    borderColor: filteredData.map(d => borderColors[d.type]),
                    borderWidth: 2
                }]
            };

            charts.type = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label}: ${value.toLocaleString()} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
        }

        function createAgeDistributionChart(data, filter) {
            const ctx = document.getElementById('ageDistributionChart').getContext('2d');
            if (charts.ageDistribution) charts.ageDistribution.destroy();

            if (!data.yearly_age_distribution) {
                console.error("Age distribution data is missing from JSON.");
                return;
            }

            const ageBins = [
                { dataKey: '0-5 years', displayLabel: '0-5 years (5yr span)' },
                { dataKey: '5-10 years', displayLabel: '5-10 years (5yr span)' },
                { dataKey: '10-20 years', displayLabel: '10-20 years (10yr span)' },
                { dataKey: '20-30 years', displayLabel: '20-30 years (10yr span)' },
                { dataKey: '30-50 years', displayLabel: '30-50 years (20yr span)' },
                { dataKey: '50-75 years', displayLabel: '50-75 years (25yr span)' },
                { dataKey: '75-100 years', displayLabel: '75-100 years (25yr span)' },
                { dataKey: '100-150 years', displayLabel: '100-150 years (50yr span)' },
                { dataKey: '150+ years', displayLabel: '150+ years' }
            ];
            
            const plasmaColors = [
                'rgba(13, 8, 135, 0.8)', 'rgba(84, 2, 163, 0.8)', 'rgba(139, 10, 165, 0.8)',
                'rgba(185, 50, 137, 0.8)', 'rgba(219, 92, 104, 0.8)', 'rgba(244, 136, 73, 0.8)',
                'rgba(254, 188, 43, 0.8)', 'rgba(240, 249, 33, 0.8)', 'rgba(240, 249, 33, 0.9)'
            ];

            const filterKey = filter === 'all' ? 'All' : filter;
            const years = Object.keys(data.yearly_age_distribution).sort();
            
            const datasets = ageBins.map((bin, index) => {
                const binData = years.map(year => {
                    return data.yearly_age_distribution[year]?.[filterKey]?.[bin.dataKey] || 0;
                });
                
                return {
                    label: bin.displayLabel,
                    data: binData,
                    backgroundColor: plasmaColors[index],
                    borderWidth: 1
                };
            });
            
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            title: { display: true, text: 'Demolition Year' }
                        },
                        y: {
                            stacked: true,
                            grid: { borderDash: [2, 2] },
                            title: { display: true, text: `Number of Buildings (${filterKey} Types)` }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'right', 
                            reverse: true,
                            onClick: (e, legendItem, legend) => {
                                const ci = legend.chart;
                                const clickedIndex = legendItem.datasetIndex;
                                const totalDatasets = ci.data.datasets.length;
                                
                                let isAlreadyIsolated = true;
                                for (let i = 0; i < totalDatasets; i++) {
                                    if (i !== clickedIndex && ci.isDatasetVisible(i)) {
                                        isAlreadyIsolated = false;
                                        break;
                                    }
                                }

                                if (isAlreadyIsolated && ci.isDatasetVisible(clickedIndex)) {
                                    for (let i = 0; i < totalDatasets; i++) {
                                        ci.show(i);
                                    }
                                } else {
                                    for (let i = 0; i < totalDatasets; i++) {
                                        if (i === clickedIndex) {
                                            ci.show(i);
                                        } else {
                                            ci.hide(i);
                                        }
                                    }
                                }
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            };
            
            charts.ageDistribution = new Chart(ctx, chartConfig);
        }

        // NEW: Function to create construction era chart
        function createConstructionEraChart(data, filter) {
            const ctx = document.getElementById('constructionEraChart').getContext('2d');
            if (charts.constructionEra) charts.constructionEra.destroy();

            if (!data.yearly_construction_era) {
                console.error("Construction era data is missing from JSON.");
                return;
            }

            const eras = [
                'Pre-1900', '1900-1920', '1920-1940', '1940-1960',
                '1960-1980', '1980-2000', '2000-2010', '2010-2020', '2020+'
            ];
            
            const eraColors = [
                'rgba(13, 8, 135, 0.8)', 'rgba(84, 2, 163, 0.8)', 'rgba(139, 10, 165, 0.8)',
                'rgba(185, 50, 137, 0.8)', 'rgba(219, 92, 104, 0.8)', 'rgba(244, 136, 73, 0.8)',
                'rgba(254, 188, 43, 0.8)', 'rgba(240, 249, 33, 0.8)', 'rgba(250, 250, 100, 0.9)'
            ];

            const filterKey = filter === 'all' ? 'All' : filter;
            const years = Object.keys(data.yearly_construction_era).sort();
            
            const datasets = eras.map((era, index) => {
                const eraData = years.map(year => {
                    return data.yearly_construction_era[year]?.[filterKey]?.[era] || 0;
                });
                
                return {
                    label: era,
                    data: eraData,
                    backgroundColor: eraColors[index],
                    borderWidth: 1
                };
            });
            
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            title: { display: true, text: 'Demolition Year' },
                            ticks: {
                                callback: function(value, index) {
                                    const year = years[index];
                                    const yearRange = years[years.length - 1] - years[0];
                                    if (yearRange <= 20) return year;
                                    else if (yearRange <= 30) return year % 2 === 0 ? year : '';
                                    else if (yearRange <= 50) return year % 5 === 0 ? year : '';
                                    else return year % 10 === 0 ? year : '';
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            stacked: true,
                            grid: { borderDash: [2, 2] },
                            title: { display: true, text: `Number of Buildings (${filterKey} Types)` }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'right', 
                            reverse: true,
                            onClick: (e, legendItem, legend) => {
                                const ci = legend.chart;
                                const clickedIndex = legendItem.datasetIndex;
                                const totalDatasets = ci.data.datasets.length;
                                
                                let isAlreadyIsolated = true;
                                for (let i = 0; i < totalDatasets; i++) {
                                    if (i !== clickedIndex && ci.isDatasetVisible(i)) {
                                        isAlreadyIsolated = false;
                                        break;
                                    }
                                }

                                if (isAlreadyIsolated && ci.isDatasetVisible(clickedIndex)) {
                                    for (let i = 0; i < totalDatasets; i++) {
                                        ci.show(i);
                                    }
                                } else {
                                    for (let i = 0; i < totalDatasets; i++) {
                                        if (i === clickedIndex) {
                                            ci.show(i);
                                        } else {
                                            ci.hide(i);
                                        }
                                    }
                                }
                            }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            };
            
            charts.constructionEra = new Chart(ctx, chartConfig);
        }

        // NEW: Strip plot to replace box plot
        function createLifespanStripPlot(data, filter) {
            const ctx = document.getElementById('lifespanStripPlot').getContext('2d');
            
            if (charts.lifespanStripPlot) charts.lifespanStripPlot.destroy();
            
            if (!data.lifespan_by_year_boxplot) {
                console.warn('No boxplot data available');
                return;
            }
            
            // Get data for the selected filter
            let boxplotData;
            if (typeof data.lifespan_by_year_boxplot === 'object' && !Array.isArray(data.lifespan_by_year_boxplot)) {
                boxplotData = data.lifespan_by_year_boxplot[filter === 'all' ? 'All' : filter] || [];
            } else {
                // Fallback for old data format
                boxplotData = data.lifespan_by_year_boxplot;
            }
            
            // Create arrays for different data series
            const years = boxplotData.map(d => d.year.toString());
            const stripData = [];
            const medianData = [];
            const meanData = [];
            
            // Process each year's data
            boxplotData.forEach((yearData, yearIndex) => {
                const lifespans = [...yearData.lifespans].sort((a, b) => a - b);
                const n = lifespans.length;
                
                if (n > 0) {
                    // Calculate statistics
                    const median = lifespans[Math.floor(n * 0.5)];
                    const mean = lifespans.reduce((a, b) => a + b, 0) / n;
                    
                    medianData.push(median);
                    meanData.push(mean);
                    
                    // Create individual points for strip plot
                    yearData.lifespans.forEach(lifespan => {
                        stripData.push({
                            x: yearData.year.toString(),  // Use year string for category axis
                            y: lifespan
                        });
                    });
                } else {
                    medianData.push(null);
                    meanData.push(null);
                }
            });
            
            const datasets = [
                {
                    label: 'Individual Buildings',
                    data: stripData,
                    backgroundColor: 'rgba(126, 3, 168, 0.3)',
                    borderColor: 'rgba(126, 3, 168, 0.5)',
                    pointRadius: 1.5,  // Small points
                    pointHoverRadius: 3,
                    type: 'scatter'
                },
                {
                    label: 'Median',
                    data: medianData,
                    borderColor: 'rgba(255, 200, 0, 1)',
                    backgroundColor: 'rgba(255, 200, 0, 0.8)',
                    borderWidth: 1,
                    pointRadius: 0,
                    type: 'line',
                    tension: 0.1
                },
                {
                    label: 'Mean',
                    data: meanData,
                    borderColor: 'rgba(255, 100, 0, 1)',
                    backgroundColor: 'rgba(255, 100, 0, 0.8)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    type: 'line',
                    tension: 0.1
                }
            ];
            
            const chartConfig = {
                type: 'scatter',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',  // Use category scale for proper spacing
                            grid: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    const year = years[index];
                                    const yearRange = parseInt(years[years.length - 1]) - parseInt(years[0]);
                                    
                                    if (yearRange <= 20) {
                                        return year;
                                    } else if (yearRange <= 30) {
                                        return parseInt(year) % 2 === 0 ? year : '';
                                    } else if (yearRange <= 50) {
                                        return parseInt(year) % 5 === 0 ? year : '';
                                    } else {
                                        return parseInt(year) % 10 === 0 ? year : '';
                                    }
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            },
                            title: { display: true, text: 'Demolition Year' }
                        },
                        y: {
                            grid: { borderDash: [2, 2] },
                            title: { display: true, text: 'Building Age at Demolition (Years)' },
                            min: 0,
                            ticks: {
                                callback: function(value) { return value + ' yrs'; }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                generateLabels: function(chart) {
                                    const items = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    items.forEach(item => {
                                        if (item.text === 'Individual Buildings') {
                                            const totalPoints = stripData.length;
                                            item.text = `Individual Buildings (${totalPoints} total)`;
                                        }
                                    });
                                    return items;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label && context.dataset.label.includes('Individual Buildings')) {
                                        const dataPoint = context.raw;
                                        return `Year: ${dataPoint.x}, Age: ${dataPoint.y} years`;
                                    } else if (context.dataset.label === 'Median') {
                                        return `Median: ${context.parsed.y.toFixed(1)} years`;
                                    } else if (context.dataset.label === 'Mean') {
                                        return `Mean: ${context.parsed.y.toFixed(1)} years`;
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            };
            
            charts.lifespanStripPlot = new Chart(ctx, chartConfig);
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('demolitionFilter').value = 'RAZE';
            
            document.getElementById('totalDemo').textContent = 'Loading...';
            document.getElementById('avgLifespan').innerHTML = 'Loading...';
            document.getElementById('extdemCount').textContent = 'Loading...';
            document.getElementById('intdemCount').textContent = 'Loading...';
            
            loadDataFromJSON();
        });
    </script>
</body>
</html>